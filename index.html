<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rialo Explorer ‚Äî Camera-Relative Controls</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; font-family: Arial, sans-serif; }
    #scoreboard {
      position: fixed; top: 10px; left: 10px;
      color: white; font-size: 18px;
      background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 6px; z-index: 10;
    }
    #message {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      color: yellow; font-size: 16px;
      background: rgba(0,0,0,0.6); padding: 6px 12px; border-radius: 6px;
      display: none; z-index: 10;
    }
    #controls { position: fixed; bottom: 30px; left: 20px; display: none; gap: 12px; z-index: 20; }
    #actions { position: fixed; bottom: 30px; right: 20px; display: none; flex-direction: column; gap: 12px; z-index: 20; }
    .btn {
      width: 56px; height: 56px; border-radius: 50%;
      background: rgba(255,255,255,0.12); border: 2px solid white;
      color: white; font-size: 26px; display: flex; justify-content: center; align-items: center;
      user-select: none; touch-action: none; cursor: pointer;
    }
    .btn:active { background: rgba(255,255,255,0.28); }
    #startScreen {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.92); display:flex; flex-direction:column; justify-content:center; align-items:center;
      z-index:100; color:white;
    }
    #startButton {
      margin-top: 20px; padding: 12px 24px; font-size: 20px; border:2px solid white;
      background: transparent; color: white; border-radius: 8px; cursor: pointer;
    }
    #startButton:hover { background: rgba(255,255,255,0.12); }
    @media (max-width:700px) {
      .btn { width:50px; height:50px; font-size:22px; }
      #controls { left:12px; bottom:16px; }
      #actions { right:12px; bottom:16px; }
    }
  </style>
</head>
<body>
  <div id="scoreboard">Rialo Points: 0</div>
  <div id="message"></div>

  <div id="controls">
    <div class="btn" data-key="ArrowLeft">‚¨ÖÔ∏è</div>
    <div class="btn" data-key="ArrowUp">‚¨ÜÔ∏è</div>
    <div class="btn" data-key="ArrowDown">‚¨áÔ∏è</div>
    <div class="btn" data-key="ArrowRight">‚û°Ô∏è</div>
  </div>

  <div id="actions">
    <div class="btn" id="btnE">E</div>
  </div>

  <div id="startScreen">
    <h1 style="font-size:48px;margin:0;">Rialo Explorer</h1>
    <p style="margin:12px 0 0 0;color:#ddd;">Collect resources (E) and earn Rialo Points.</p>
    <button id="startButton">Start Game</button>
  </div>

  <!-- three.js + OrbitControls -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.136.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.136.0/examples/js/controls/OrbitControls.js"></script>

  <script>
  // ---------- Globals ----------
  let scene, camera, renderer, controls;
  let player, resources = [];
  let score = 0;
  const scoreboard = document.getElementById("scoreboard");
  const message = document.getElementById("message");
  const startScreen = document.getElementById("startScreen");
  const keys = {};
  let inited = false;
  let gameOver = false;
  let resourceSpawner;
  const clock = new THREE.Clock();

  let armL, armR, legL, legR;
  let walkCycle = 0;

  // ---------- Character (primitive human) ----------
  function createHuman() {
    const g = new THREE.Group();
    const bodyMat = new THREE.MeshStandardMaterial({ color: 0x3366cc });
    const skinMat = new THREE.MeshStandardMaterial({ color: 0xffcc99 });
    const legMat = new THREE.MeshStandardMaterial({ color: 0x222222 });

    const body = new THREE.Mesh(new THREE.BoxGeometry(1,1.5,0.6), bodyMat);
    body.position.set(0,1,0); g.add(body);

    const head = new THREE.Mesh(new THREE.SphereGeometry(0.4, 24, 20), skinMat);
    head.position.set(0,2.2,0); g.add(head);

    const armGeo = new THREE.CylinderGeometry(0.15,0.15,1.2,12);
    armL = new THREE.Mesh(armGeo, bodyMat); armL.position.set(-0.7,1,0);
    armR = new THREE.Mesh(armGeo, bodyMat); armR.position.set(0.7,1,0);
    // set rotation pivots: put arms into parent pivot for nicer rotation
    const armLPivot = new THREE.Group(); armLPivot.add(armL); armLPivot.position.copy(armL.position); armL.position.set(0,0,0);
    const armRPivot = new THREE.Group(); armRPivot.add(armR); armRPivot.position.copy(armR.position); armR.position.set(0,0,0);
    g.add(armLPivot, armRPivot);

    const legGeo = new THREE.CylinderGeometry(0.18,0.18,1.2,12);
    legL = new THREE.Mesh(legGeo, legMat); legL.position.set(-0.3,0,0);
    legR = new THREE.Mesh(legGeo, legMat); legR.position.set(0.3,0,0);
    const legLPivot = new THREE.Group(); legLPivot.add(legL); legLPivot.position.copy(legL.position); legL.position.set(0,0,0);
    const legRPivot = new THREE.Group(); legRPivot.add(legR); legRPivot.position.copy(legR.position); legR.position.set(0,0,0);
    g.add(legLPivot, legRPivot);

    // store pivot refs for animation
    armL = armLPivot; armR = armRPivot;
    legL = legLPivot; legR = legRPivot;

    g.position.set(0,0.6,0);
    return g;
  }

  // ---------- Banner ----------
  function createBanner() {
    const canvas = document.createElement('canvas');
    canvas.width = 1024; canvas.height = 256;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width, canvas.height);
    ctx.fillStyle = '#000';
    ctx.font = 'bold 180px Arial';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText('RIALO', canvas.width/2, canvas.height/2+6);
    const tex = new THREE.CanvasTexture(canvas);
    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex, transparent: true }));
    sprite.scale.set(30, 7.5, 1); sprite.position.set(0, 10, -18);
    scene.add(sprite);
  }

  // ---------- Spawners ----------
  function spawnTree() {
    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.28,0.36,2.2,8), new THREE.MeshStandardMaterial({ color:0x6b3f1f }));
    trunk.position.y=1.1;
    const leaves = new THREE.Mesh(new THREE.SphereGeometry(1.1, 10, 8), new THREE.MeshStandardMaterial({ color:0x1f7a18 }));
    leaves.position.y=2.6;
    const tree = new THREE.Group(); tree.add(trunk, leaves);
    tree.position.set((Math.random()-0.5)*60,0,(Math.random()-0.5)*60);
    scene.add(tree); resources.push({ mesh:tree, type:"tree", points:5 });
  }
  function spawnRock() {
    const rock = new THREE.Mesh(new THREE.IcosahedronGeometry(0.9,0), new THREE.MeshStandardMaterial({ color:0x7f7f7f }));
    rock.position.set((Math.random()-0.5)*60,0.5,(Math.random()-0.5)*60);
    scene.add(rock); resources.push({ mesh:rock, type:"rock", points:8 });
  }
  function spawnGold() {
    const gold = new THREE.Mesh(new THREE.SphereGeometry(0.5,12,12), new THREE.MeshStandardMaterial({ color:0xffd700 }));
    gold.position.set((Math.random()-0.5)*60,0.6,(Math.random()-0.5)*60);
    scene.add(gold); resources.push({ mesh:gold, type:"gold", points:15 });
  }

  // ---------- UI helpers ----------
  function flashMessage(txt) {
    message.innerText=txt; message.style.display="block";
    clearTimeout(message._hideTimeout);
    message._hideTimeout=setTimeout(()=>message.style.display="none",1400);
  }

  function gatherResource() {
    if (!player || gameOver) return;
    let closest=null, minDist=3.2;
    for (let r of resources) {
      const d = player.position.distanceTo(r.mesh.position);
      if (d < minDist) { minDist = d; closest = r; }
    }
    if (closest) {
      scene.remove(closest.mesh);
      const idx = resources.indexOf(closest); if (idx>=0) resources.splice(idx,1);
      score += closest.points;
      scoreboard.innerText = "Rialo Points: " + score;
      flashMessage("Collected " + closest.type + " (+ " + closest.points + ")");
      if (score >= 100000) endGameWinner();
    } else flashMessage("No resource nearby");
  }

  // ---------- Init Game ----------
  function initGame() {
    if (inited) return; inited = true;
    scene = new THREE.Scene(); scene.background = new THREE.Color(0x87ceeb);

    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 6, 10);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // OrbitControls: mouse/touch rotate camera around controls.target
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enablePan = false;
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.minDistance = 4;
    controls.maxDistance = 18;
    controls.maxPolarAngle = Math.PI * 0.49; // prevent camera under ground

    // lighting & ground
    const dir = new THREE.DirectionalLight(0xffffff, 1); dir.position.set(10,20,10);
    dir.castShadow = true; scene.add(dir);
    scene.add(new THREE.AmbientLight(0x666666, 0.9));
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(300,300), new THREE.MeshStandardMaterial({ color: 0x2b6b2b }));
    ground.rotation.x = -Math.PI/2; ground.receiveShadow = true; scene.add(ground);

    // player & UI
    player = createHuman(); scene.add(player);
    createBanner();

    // spawn initial resources (bigger pool)
    for (let i=0;i<40;i++) spawnTree();
    for (let i=0;i<30;i++) spawnRock();
    for (let i=0;i<20;i++) spawnGold();

    // resource respawn interval
    resourceSpawner = setInterval(()=>{
      if (gameOver) return;
      const r = Math.random();
      if (r < 0.6) spawnTree(); else if (r < 0.9) spawnRock(); else spawnGold();
      // optional cap: remove oldest if too many (not done now)
    }, 5000);

    document.getElementById("controls").style.display='flex';
    document.getElementById("actions").style.display='flex';

    window.addEventListener('resize', onWindowResize);

    // set controls target initially to player
    controls.target.copy(player.position);
    // position camera a little behind the player for initial view
    camera.position.set(player.position.x, player.position.y + 3.5, player.position.z + 9);
    controls.update();

    animate();
  }

  // ---------- End Game ----------
  function endGameWinner() {
    gameOver = true;
    clearInterval(resourceSpawner);
    document.getElementById("controls").style.display='none';
    document.getElementById("actions").style.display='none';

    const canvas = document.createElement('canvas'); canvas.width=1024; canvas.height=256;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ffcc00'; ctx.font='bold 200px Arial';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('WINNER!', canvas.width/2, canvas.height/2);
    const tex = new THREE.CanvasTexture(canvas);
    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({map:tex, transparent:true}));
    sprite.scale.set(35,10,1); sprite.position.set(0,12,-15);
    scene.add(sprite);

    flashMessage("You reached 100000 Rialo Points! üéâ");

    setTimeout(()=>{ location.reload(); }, 5000);
  }

  function onWindowResize() {
    if (!camera || !renderer) return;
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  // ---------- Input ----------
  window.addEventListener("keydown", e => { keys[e.code] = true; if (e.code === "KeyE") gatherResource(); });
  window.addEventListener("keyup", e => { keys[e.code] = false; });
  document.querySelectorAll("#controls .btn").forEach(btn=>{
    const key = btn.dataset.key;
    btn.addEventListener("pointerdown", ev => { ev.preventDefault(); keys[key] = true; });
    btn.addEventListener("pointerup", ev => { ev.preventDefault(); keys[key] = false; });
    btn.addEventListener("pointercancel", ev => { ev.preventDefault(); keys[key] = false; });
    btn.addEventListener("pointerleave", ev => { ev.preventDefault(); keys[key] = false; });
  });
  document.getElementById("btnE").addEventListener("pointerdown", ev => { ev.preventDefault(); gatherResource(); });
  document.getElementById("startButton").addEventListener("click", ()=>{ startScreen.style.display='none'; initGame(); });

  // ---------- Animate / Game Loop ----------
  function animate() {
    requestAnimationFrame(animate);
    const dt = clock.getDelta();

    if (player && !gameOver) {
      // --- camera-relative movement: use camera's forward/right in XZ plane ---
      const camForward = new THREE.Vector3();
      camera.getWorldDirection(camForward);
      camForward.y = 0; camForward.normalize();

      const camRight = new THREE.Vector3();
      camRight.crossVectors(camForward, new THREE.Vector3(0,1,0)).normalize();

      const move = new THREE.Vector3();
      if (keys['KeyW'] || keys['ArrowUp']) move.add(camForward);
      if (keys['KeyS'] || keys['ArrowDown']) move.sub(camForward);
      if (keys['KeyA'] || keys['ArrowLeft']) move.sub(camRight);
      if (keys['KeyD'] || keys['ArrowRight']) move.add(camRight);

      if (move.lengthSq() > 0.0001) {
        move.normalize();
        // step
        const speed = 6; // units / second
        player.position.addScaledVector(move, speed * dt);

        // rotate player to face movement direction (smooth)
        const target = player.position.clone().add(move);
        player.lookAt(target);

        // walk animation (swing pivots)
        walkCycle += dt * 6;
        const swing = Math.sin(walkCycle) * 0.6;
        if (armL) armL.rotation.x = swing;
        if (armR) armR.rotation.x = -swing;
        if (legL) legL.rotation.x = -swing;
        if (legR) legR.rotation.x = swing;
      } else {
        // relax limbs
        if (armL) armL.rotation.x *= 0.8;
        if (armR) armR.rotation.x *= 0.8;
        if (legL) legL.rotation.x *= 0.8;
        if (legR) legR.rotation.x *= 0.8;
      }

      // --- camera follow via OrbitControls.target (so mouse can rotate around player) ---
      // we lerp target to player's position for smoothness
      controls.target.lerp(player.position.clone().add(new THREE.Vector3(0,1.0,0)), 0.15);

      // optionally keep camera height offset when far/near - OrbitControls handles distance via user zoom
      controls.update();
    } else {
      // still update controls so user can rotate camera on start screen (optional)
      controls.update();
    }

    renderer.render(scene, camera);
  }
  </script>
</body>
</html>
