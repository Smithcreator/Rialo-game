<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rialo Explorer ‚Äî Final Edition</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; font-family: Arial, sans-serif; }
    #scoreboard {
      position: fixed; top: 10px; left: 10px;
      color: white; font-size: 18px;
      background: rgba(0,0,0,0.5); padding: 8px 12px; border-radius: 6px; z-index: 10;
    }
    #message {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      color: yellow; font-size: 16px;
      background: rgba(0,0,0,0.6); padding: 6px 12px; border-radius: 6px;
      display: none; z-index: 10;
    }
    #controls { position: fixed; bottom: 30px; left: 20px; display: none; gap: 15px; z-index: 20; }
    #actions { position: fixed; bottom: 30px; right: 20px; display: none; flex-direction: column; gap: 15px; z-index: 20; }
    .btn {
      width: 60px; height: 60px; border-radius: 50%;
      background: rgba(255,255,255,0.12); border: 2px solid white;
      color: white; font-size: 28px; display: flex; justify-content: center; align-items: center;
      user-select: none; touch-action: none; cursor: pointer;
    }
    .btn:active { background: rgba(255,255,255,0.28); }
    #startScreen {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.92); display:flex; flex-direction:column; justify-content:center; align-items:center;
      z-index:100; color:white;
    }
    #startButton {
      margin-top: 20px; padding: 12px 24px; font-size: 20px; border:2px solid white;
      background: transparent; color: white; border-radius: 8px; cursor: pointer;
    }
    #startButton:hover { background: rgba(255,255,255,0.12); }
  </style>
</head>
<body>
  <div id="scoreboard">Rialo Points: 0</div>
  <div id="message"></div>

  <div id="controls">
    <div class="btn" data-key="ArrowLeft">‚¨ÖÔ∏è</div>
    <div class="btn" data-key="ArrowUp">‚¨ÜÔ∏è</div>
    <div class="btn" data-key="ArrowDown">‚¨áÔ∏è</div>
    <div class="btn" data-key="ArrowRight">‚û°Ô∏è</div>
  </div>

  <div id="actions">
    <div class="btn" id="btnE">E</div>
  </div>

  <div id="startScreen">
    <h1 style="font-size:48px;margin:0;">Rialo Explorer</h1>
    <p style="margin:12px 0 0 0;color:#ddd;">Collect resources (E) and earn Rialo Points.</p>
    <button id="startButton">Start Game</button>
  </div>

  <!-- three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.136.0/build/three.min.js"></script>

  <script>
  let scene, camera, renderer;
  let player, resources = [];
  let score = 0;
  const scoreboard = document.getElementById("scoreboard");
  const message = document.getElementById("message");
  const startScreen = document.getElementById("startScreen");
  const keys = {};
  let inited = false;
  let gameOver = false;
  let resourceSpawner;
  const clock = new THREE.Clock();

  let armL, armR, legL, legR; // –¥–ª—è –∞–Ω—ñ–º–∞—Ü—ñ—ó
  let walkCycle = 0;

  // ====== Human character ======
  function createHuman() {
    const g = new THREE.Group();
    const bodyMat = new THREE.MeshStandardMaterial({ color: 0x3366cc });
    const skinMat = new THREE.MeshStandardMaterial({ color: 0xffcc99 });
    const legMat = new THREE.MeshStandardMaterial({ color: 0x222222 });

    // –¢—ñ–ª–æ
    const body = new THREE.Mesh(new THREE.BoxGeometry(1,1.5,0.6), bodyMat);
    body.position.set(0,1,0);
    g.add(body);

    // –ì–æ–ª–æ–≤–∞
    const head = new THREE.Mesh(new THREE.SphereGeometry(0.4, 24, 20), skinMat);
    head.position.set(0,2.2,0);
    g.add(head);

    // –†—É–∫–∏
    const armGeo = new THREE.CylinderGeometry(0.15,0.15,1.2,12);
    armL = new THREE.Mesh(armGeo, bodyMat); armL.position.set(-0.7,1,0);
    armR = new THREE.Mesh(armGeo, bodyMat); armR.position.set(0.7,1,0);
    g.add(armL, armR);

    // –ù–æ–≥–∏
    const legGeo = new THREE.CylinderGeometry(0.18,0.18,1.2,12);
    legL = new THREE.Mesh(legGeo, legMat); legL.position.set(-0.3,0,0);
    legR = new THREE.Mesh(legGeo, legMat); legR.position.set(0.3,0,0);
    g.add(legL, legR);

    g.position.set(0,0.6,0);
    return g;
  }

  // ====== Banner RIALO ======
  function createBanner() {
    const canvas = document.createElement('canvas');
    canvas.width = 1024; canvas.height = 256;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width, canvas.height);
    ctx.fillStyle = '#000';
    ctx.font = 'bold 180px Arial';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText('RIALO', canvas.width/2, canvas.height/2+6);
    const tex = new THREE.CanvasTexture(canvas);
    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex, transparent: true }));
    sprite.scale.set(30, 7.5, 1); sprite.position.set(0, 10, -18);
    scene.add(sprite);
  }

  // ====== Spawners ======
  function spawnTree() {
    const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.28,0.36,2.2,8), new THREE.MeshStandardMaterial({ color:0x6b3f1f }));
    trunk.position.y=1.1;
    const leaves = new THREE.Mesh(new THREE.SphereGeometry(1.1, 10, 8), new THREE.MeshStandardMaterial({ color:0x1f7a18 }));
    leaves.position.y=2.6;
    const tree = new THREE.Group(); tree.add(trunk, leaves);
    tree.position.set((Math.random()-0.5)*60,0,(Math.random()-0.5)*60);
    scene.add(tree); resources.push({ mesh:tree, type:"tree", points:5 });
  }
  function spawnRock() {
    const rock = new THREE.Mesh(new THREE.IcosahedronGeometry(0.9,0), new THREE.MeshStandardMaterial({ color:0x7f7f7f }));
    rock.position.set((Math.random()-0.5)*60,0.5,(Math.random()-0.5)*60);
    scene.add(rock); resources.push({ mesh:rock, type:"rock", points:8 });
  }
  function spawnGold() {
    const gold = new THREE.Mesh(new THREE.SphereGeometry(0.5,12,12), new THREE.MeshStandardMaterial({ color:0xffd700 }));
    gold.position.set((Math.random()-0.5)*60,0.6,(Math.random()-0.5)*60);
    scene.add(gold); resources.push({ mesh:gold, type:"gold", points:15 });
  }

  function flashMessage(txt) {
    message.innerText=txt; message.style.display="block";
    clearTimeout(message._hideTimeout);
    message._hideTimeout=setTimeout(()=>message.style.display="none",1400);
  }

  function gatherResource() {
    if (!player || gameOver) return;
    let closest=null,minDist=3.2;
    for (let r of resources) {
      const d=player.position.distanceTo(r.mesh.position);
      if (d<minDist){minDist=d;closest=r;}
    }
    if (closest){
      scene.remove(closest.mesh);
      resources.splice(resources.indexOf(closest),1);
      score+=closest.points;
      scoreboard.innerText="Rialo Points: "+score;
      flashMessage("Collected "+closest.type+" (+ "+closest.points+")");
      if (score>=100000) endGameWinner();
    } else flashMessage("No resource nearby");
  }

  // ====== Game init ======
  function initGame() {
    if (inited) return; inited=true;
    scene=new THREE.Scene(); scene.background=new THREE.Color(0x87ceeb);
    camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,0.1,1000);
    camera.position.set(0,6,12);
    renderer=new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(window.innerWidth,window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const dir=new THREE.DirectionalLight(0xffffff,1); dir.position.set(10,20,10);
    scene.add(dir,new THREE.AmbientLight(0x666666,0.8));
    const ground=new THREE.Mesh(new THREE.PlaneGeometry(300,300),new THREE.MeshStandardMaterial({color:0x2b6b2b}));
    ground.rotation.x=-Math.PI/2; scene.add(ground);

    player=createHuman(); scene.add(player);
    createBanner();

    for(let i=0;i<30;i++) spawnTree();
    for(let i=0;i<20;i++) spawnRock();
    for(let i=0;i<15;i++) spawnGold();

    resourceSpawner=setInterval(()=>{
      if(gameOver) return;
      const r=Math.random();
      if(r<0.6) spawnTree(); else if(r<0.9) spawnRock(); else spawnGold();
    },5000);

    document.getElementById("controls").style.display='flex';
    document.getElementById("actions").style.display='flex';

    window.addEventListener('resize',onWindowResize);
    animate();
  }

  function endGameWinner(){
    gameOver=true;
    clearInterval(resourceSpawner);
    document.getElementById("controls").style.display='none';
    document.getElementById("actions").style.display='none';

    const canvas=document.createElement('canvas');
    canvas.width=1024; canvas.height=256;
    const ctx=canvas.getContext('2d');
    ctx.fillStyle='#ffcc00'; ctx.font='bold 200px Arial';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText('WINNER!',canvas.width/2,canvas.height/2);
    const tex=new THREE.CanvasTexture(canvas);
    const sprite=new THREE.Sprite(new THREE.SpriteMaterial({map:tex,transparent:true}));
    sprite.scale.set(35,10,1); sprite.position.set(0,12,-15);
    scene.add(sprite);

    flashMessage("You reached 100000 Rialo Points! üéâ");

    setTimeout(()=>{ location.reload(); },5000);
  }

  function onWindowResize(){
    camera.aspect=window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
  }

  // ====== input ======
  window.addEventListener("keydown",e=>{keys[e.code]=true;if(e.code==="KeyE") gatherResource();});
  window.addEventListener("keyup",e=>{keys[e.code]=false;});
  document.querySelectorAll("#controls .btn").forEach(btn=>{
    const key=btn.dataset.key;
    btn.addEventListener("pointerdown",ev=>{ev.preventDefault();keys[key]=true;});
    btn.addEventListener("pointerup",()=>keys[key]=false);
  });
  document.getElementById("btnE").addEventListener("pointerdown",ev=>{ev.preventDefault();gatherResource();});
  document.getElementById("startButton").addEventListener("click",()=>{startScreen.style.display='none';initGame();});

  function animate(){
    requestAnimationFrame(animate);
    const dt=clock.getDelta();
    if(player && !gameOver){
      let moveDir = new THREE.Vector3();

      // —Ä—É—Ö –≤—ñ–¥–Ω–æ—Å–Ω–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
      const forward = new THREE.Vector3(0,0,1).applyQuaternion(player.quaternion);
      forward.y = 0; forward.normalize();
      const right = new THREE.Vector3().crossVectors(forward,new THREE.Vector3(0,1,0)).normalize();

      if(keys['KeyW'] || keys['ArrowUp']) moveDir.add(forward);
      if(keys['KeyS'] || keys['ArrowDown']) moveDir.sub(forward);
      if(keys['KeyA'] || keys['ArrowLeft']) moveDir.sub(right);
      if(keys['KeyD'] || keys['ArrowRight']) moveDir.add(right);

      if(moveDir.length()>0){
        moveDir.normalize();
        player.position.addScaledVector(moveDir, 5*dt);
        player.lookAt(player.position.clone().add(moveDir));

        walkCycle += dt*6;
        const swing = Math.sin(walkCycle)*0.6;
        if(armL) armL.rotation.x = swing;
        if(armR) armR.rotation.x = -swing;
        if(legL) legL.rotation.x = -swing;
        if(legR) legR.rotation.x = swing;
      } else {
        if(armL) armL.rotation.x *= 0.8;
        if(armR) armR.rotation.x *= 0.8;
        if(legL) legL.rotation.x *= 0.8;
        if(legR) legR.rotation.x *= 0.8;
      }

      // ===== –ö–ê–ú–ï–†–ê –°–õ–Ü–î–£–Ñ =====
      const offset = new THREE.Vector3(0,3,-6);
      const camPos = player.position.clone().add(offset.applyQuaternion(player.quaternion));
      camera.position.lerp(camPos,0.1);
      camera.lookAt(player.position.clone().add(new THREE.Vector3(0,1.5,0)));
    }

    renderer.render(scene,camera);
  }
  </script>
</body>
</html>
